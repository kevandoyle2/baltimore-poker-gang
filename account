<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account — Baltimore Poker Gang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKS9PstXhK_9lWVW6IRkCAJ_Gl0G8XlUw",
      authDomain: "baltimore-poker-gang.firebaseapp.com",
      projectId: "baltimore-poker-gang",
      storageBucket: "baltimore-poker-gang.firebasestorage.app",
      messagingSenderId: "1082334625118",
      appId: "1:1082334625118:web:3f90a5721f9f1f2790a3cf",
      measurementId: "G-WG9B6920WS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.auth = auth;
    window.db = db;
  </script>
</head>
<body x-data="accountPage()" x-init="init()" class="min-h-screen">

  <nav class="bg-black p-4 shadow-lg">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/" class="text-2xl font-bold flex items-center gap-3">
        <i class="fas fa-diamond text-red-600"></i> Baltimore Poker Gang
      </a>
      <div>
        <a href="/leaderboard" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold mr-4">Leaderboard</a>
        <button @click="logout()" class="bg-gray-700 hover:bg-gray-600 px-6 py-500 px-6 py-2 rounded font-bold">Logout</button>
      </div>
    </div>
  </nav>

  <div class="max-w-5xl mx-auto p-6">
    <h2 class="text-4xl font-bold text-center mb-10" x-text="'Welcome, ${username}!"></h2>

    <!-- Add Session -->
    <div class="bg-gray-800 p-8 rounded-xl shadow-xl mb-10">
      <h3 class="text-2xl font-bold mb-6">Log a Session</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <input type="date" x-model="newSession.date" class="p-3 bg-gray-700 rounded-lg" required />
        <input type="number" x-model.number="newSession.buyin" placeholder="Buy-in ($)" class="p-3 bg-gray-700 rounded-lg" step="5" />
        <input type="number" x-model.number="newSession.cashout" placeholder="Cash-out ($)" class="p-3 bg-gray-700 rounded-lg" step="5" />
      </div>
      <button @click="addSession()" class="mt-6 bg-green-600 hover:bg-green-500 px-8 py-3 rounded-lg font-bold">Add Session</button>
    </div>

    <!-- Sessions Table -->
    <div class="bg-gray-800 rounded-xl overflow-hidden shadow-xl">
      <h3 class="text-2xl font-bold p-6 bg-gray-900">Your Session History</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-900">
            <tr>
              <th class="p-4 text-left">Date</th>
              <th class="p-4 text-left">Buy-in</th>
              <th class="p-4 text-left">Cash-out</th>
              <th class="p-4 text-left">Profit/Loss</th>
              <th class="p-4"></th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(s, i) in sessions" :key="s.id">
              <tr class="border-t border-gray-700 hover:bg-gray-750">
                <td class="p-4" x-text="s.date"></td>
                <td class="p-4">$<span x-text="s.buyin"></span></td>
                <td class="p-4">$<span x-text="s.cashout"></span></td>
                <td class="p-4 font-bold" :class="s.cashout - s.buyin >= 0 ? 'text-green-400' : 'text-red-400'">
                  $<span x-text="(s.cashout - s.buyin).toFixed(2)"></span>
                </td>
                <td class="p-4"><button @click="removeSession(s.id)" class="text-red-400 hover:text-red-300">Delete</button></td>
              </tr>
            </template>
            <tr x-show="sessions.length === 0">
              <td colspan="5" class="p-12 text-center text-gray-500">No sessions yet — go run it up!</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="p-6 bg-gray-900 border-t border-gray-700 grid grid-cols-3 text-center">
        <div><p class="text-gray-400">Total Buy-ins</p><p class="text-2xl">$<span x-text="totalBuyin"></span></p></div>
        <div><p class="text-gray-400">Total Cash-outs</p><p class="text-2xl">$<span x-text="totalCashout"></span></p></div>
        <div><p class="text-gray-400">Net Result</p><p class="text-3xl font-bold" :class="net >= 0 ? 'text-green-400' : 'text-red-400'">$<span x-text="net.toFixed(2)"></span></p></div>
      </div>
    </div>
  </div>

  <script>
    function accountPage() {
      return {
        username: '', sessions: [],
        newSession: { date: new Date().toISOString().split('T')[0], buyin: 100, cashout: 0 },

        async init() {
          onAuthStateChanged(auth, async user => {
            if (!user) return location.href = '/login';
            const q = query(collection(db, "users"), where("uid", "==", user.uid));
            const snap = await getDocs(q);
            this.username = snap.docs[0].data().username;
            await this.loadSessions();
          });
        },

        async loadSessions() {
          const q = query(collection(db, "sessions"), where("userId", "==", auth.currentUser.uid));
          const snap = await getDocs(q);
          this.sessions = snap.docs.map(d => ({id: d.id, ...d.data()}));
        },

        async addSession() {
          if (!this.newSession.date) return;
          await addDoc(collection(db, "sessions"), {
            ...this.newSession,
            userId: auth.currentUser.uid,
            username: this.username
          });
          this.newSession = { date: new Date().toISOString().split('T')[0], buyin: 100, cashout: 0 };
          await this.loadSessions();
        },

        async removeSession(id) {
          await deleteDoc(doc(db, "sessions", id));
          await this.loadSessions();
        },

        async logout() {
          await signOut(auth);
          location.href = '/';
        },

        get totalBuyin() { return this.sessions.reduce((s, x) => s + x.buyin, 0); },
        get totalCashout() { return this.sessions.reduce((s, x) => s + x.cashout, 0); },
        get net() { return this.totalCashout - this.totalBuyin; }
      }
    }
  </script>
</body>
</html>