<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account — Baltimore Poker Gang</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- UPDATED FIREBASE INITIALIZER -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      updatePassword,
      deleteUser,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, updateDoc, deleteDoc,
      collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKS9PstXhK_9lVW6IRkCAJ_Gl0G8XlUw",
      authDomain: "baltimore-poker-gang.firebaseapp.com",
      projectId: "baltimore-poker-gang",
      storageBucket: "baltimore-poker-gang.appspot.com",
      messagingSenderId: "1082334625118",
      appId: "1:1082334625118:web:3f90a5721f9f1f2790a3cf"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.auth = auth;
    window.db = db;

    window.FS = {
      doc, getDoc, updateDoc, deleteDoc,
      collection, getDocs, query, where,
      updatePassword, deleteUser
    };

    window.logout = async () => {
      await signOut(auth);
      location.href = "/index.html";
    };

    // ⭐ GUARANTEED DELIVERY FIX
    let alpineReady = false;
    window.addEventListener("alpine:init", () => {
      alpineReady = true;

      if (window.currentUser !== undefined) {
        window.dispatchEvent(new CustomEvent("auth-changed", { detail: window.currentUser }));
      }
    });

    onAuthStateChanged(auth, user => {
      window.currentUser = user;

      if (alpineReady) {
        window.dispatchEvent(new CustomEvent("auth-changed", { detail: user }));
      } else {
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent("auth-changed", { detail: user }));
        }, 50);
      }
    });
  </script>
</head>

<body class="min-h-screen bg-gray-900"
      x-data="accountPage()"
      x-init="init()">

  <!-- NAVBAR -->
  <nav class="bg-black p-4 shadow-lg"
       x-data="{ user: null }"
       x-init="
         window.addEventListener('auth-changed', e => user = e.detail);
         user = window.currentUser;
       ">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/index.html" class="text-2xl font-bold flex items-center gap-3">
        <i class="fas fa-diamond text-red-600"></i> Baltimore Poker Gang
      </a>

      <div class="flex gap-4">
        <!-- Logged OUT -->
        <template x-if="!user">
          <div class="flex gap-4">
            <a href="/leaderboard.html"
              class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold">Leaderboard</a>
            <a href="/login.html"
              class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded font-bold">Login / Sign Up</a>
          </div>
        </template>

        <!-- Logged IN -->
        <template x-if="user">
          <div class="flex gap-4">
            <a href="/leaderboard.html"
              class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold">Leaderboard</a>
            <a href="/sessions.html"
              class="px-6 py-2 bg-green-600 hover:bg-green-500 rounded font-bold">Sessions</a>
            <a href="/account.html"
              class="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold">My Account</a>
            <button @click="logout()"
              class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold">Logout</button>
          </div>
        </template>
      </div>
    </div>
  </nav>

  <!-- ACCOUNT CONTENT -->
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-4xl font-bold text-center mb-10">My Account</h1>

    <div class="bg-gray-800 p-8 rounded-xl shadow-xl">

      <template x-if="loaded">
        <div>

          <!-- REAL NAME -->
          <div class="mb-8">
            <p class="text-gray-400">Full Name</p>
            <input class="w-full p-3 mt-2 rounded bg-gray-700"
                   x-model="realName">
          </div>

          <!-- USERNAME -->
          <div class="mb-8">
            <p class="text-gray-400">Username</p>
            <input class="w-full p-3 mt-2 rounded bg-gray-700"
                   x-model="username">
            <p class="text-sm text-gray-500 mt-1">
              Letters & numbers only.
            </p>
          </div>

          <!-- PASSWORD -->
          <div class="mb-8">
            <p class="text-gray-400">New Password</p>
            <input type="password"
                   class="w-full p-3 mt-2 rounded bg-gray-700"
                   x-model="newPassword">
          </div>

          <button @click="saveChanges()"
                  class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded font-bold">
            Save Changes
          </button>

          <!-- DELETE -->
          <div class="mt-10 border-t border-gray-700 pt-6">
            <button @click="deleteAccount()"
                    class="px-6 py-3 bg-red-700 hover:bg-red-600 rounded font-bold">
              Delete Account & All Sessions
            </button>
          </div>

          <!-- MESSAGE -->
          <div class="mt-6"
               x-text="msg"
               :class="err ? 'text-red-400' : 'text-green-400'"></div>

        </div>
      </template>

      <template x-if="!loaded">
        <p class="text-gray-400">Loading...</p>
      </template>

    </div>
  </div>

  <script>
    function accountPage() {
      return {
        loaded: false,
        realName: "",
        username: "",
        newPassword: "",
        msg: "",
        err: false,

        validateUsername(name) {
          return /^[a-zA-Z0-9]+$/.test(name);
        },

        init() {
          window.auth.onAuthStateChanged(async user => {
            if (!user) {
              location.href = "/login.html";
              return;
            }

            await this.loadAccount();
          });
        },

        async loadAccount() {
          const { doc, getDoc } = window.FS;

          const userDoc = await getDoc(doc(window.db, "users", window.currentUser.uid));

          if (!userDoc.exists()) {
            this.msg = "Account record missing.";
            this.err = true;
            return;
          }

          const data = userDoc.data();

          this.realName = data.realName;
          this.username = data.username;

          this.loaded = true;
        },

        async saveChanges() {
          this.msg = "";
          this.err = false;

          if (!this.validateUsername(this.username)) {
            this.msg = "Username must contain only letters & numbers.";
            this.err = true;
            return;
          }

          try {
            const userRef = window.FS.doc(window.db, "users", window.currentUser.uid);

            await window.FS.updateDoc(userRef, {
              realName: this.realName,
              username: this.username
            });

            if (this.newPassword.length > 0) {
              await window.FS.updatePassword(window.currentUser, this.newPassword);
            }

            this.msg = "Account updated!";
          } catch (e) {
            this.msg = e.message;
            this.err = true;
          }
        },

        async deleteAccount() {
          if (!confirm("Are you sure you want to delete your entire account and all sessions?")) {
            return;
          }

          try {
            const { collection, getDocs, query, where, deleteDoc, deleteUser } = window.FS;

            // Delete all sessions
            const q = query(
              collection(window.db, "sessions"),
              where("userId", "==", window.currentUser.uid)
            );

            const snap = await getDocs(q);
            for (const d of snap.docs) {
              await deleteDoc(window.FS.doc(window.db, "sessions", d.id));
            }

            // Delete user document
            await deleteDoc(window.FS.doc(window.db, "users", window.currentUser.uid));

            // Delete Firebase auth account
            await deleteUser(window.currentUser);

            alert("Account deleted.");
            location.href = "/index.html";

          } catch (e) {
            this.msg = e.message;
            this.err = true;
          }
        }
      }
    }
  </script>

</body>
</html>