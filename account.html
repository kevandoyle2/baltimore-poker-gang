<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Account — Baltimore Poker Gang</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    updatePassword,
    deleteUser,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, updateDoc, deleteDoc,
    collection, getDocs, query, where, addDoc
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCKS9PstXhK_9lVW6IRkCAJ_Gl0G8XlUw",
    authDomain: "baltimore-poker-gang.firebaseapp.com",
    projectId: "baltimore-poker-gang",
    storageBucket: "baltimore-poker-gang.firebasestorage.app",
    messagingSenderId: "1082334625118",
    appId: "1:1082334625118:web:3f90a5721f9f1f2790a3cf"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.auth = auth;
  window.db = db;

  /* ✅ FIXED — Add FULL set of Firestore functions */
  window.FS = {
    doc, getDoc, updateDoc, deleteDoc,
    collection, getDocs, query, where, addDoc,
    updatePassword, deleteUser
  };

  window.logout = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };

  let alpineReady = false;
  window.addEventListener("alpine:init", () => {
    alpineReady = true;
    if (window.currentUser !== undefined) {
      window.dispatchEvent(new CustomEvent("auth-changed", { detail: window.currentUser }));
    }
  });

  onAuthStateChanged(auth, user => {
    window.currentUser = user;
    if (alpineReady) {
      window.dispatchEvent(new CustomEvent("auth-changed", { detail: user }));
    } else {
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent("auth-changed", { detail: user }));
      }, 50);
    }
  });
</script>
</head>

<body class="min-h-screen bg-gray-900"
      x-data="accountPage()"
      x-init="init()">

  <!-- NAVBAR -->
  <nav class="bg-black p-4 shadow-lg"
       x-data="{ user: null }"
       x-init="
         window.addEventListener('auth-changed', e => user = e.detail);
         user = window.currentUser;
       ">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/index.html" class="text-2xl font-bold flex items-center gap-3">
        <i class="fas fa-diamond text-red-600"></i> Baltimore Poker Gang
      </a>

      <div class="flex gap-4">
        <template x-if="!user">
          <div class="flex gap-4">
            <a href="/leaderboard.html" class="px-6 py-2 bg-blue-600 rounded">Leaderboard</a>
            <a href="/login.html" class="px-6 py-2 bg-red-600 rounded">Login / Sign Up</a>
          </div>
        </template>

        <template x-if="user">
          <div class="flex gap-4">
            <a href="/leaderboard.html" class="px-6 py-2 bg-blue-600 rounded">Leaderboard</a>
            <a href="/sessions.html" class="px-6 py-2 bg-green-600 rounded">Sessions</a>
            <a href="/account.html" class="px-6 py-2 bg-yellow-600 rounded">My Account</a>
            <button @click="logout()" class="px-6 py-2 bg-gray-700 rounded">Logout</button>
          </div>
        </template>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-4xl font-bold text-center mb-10">My Account</h1>

    <div class="bg-gray-800 p-8 rounded-xl shadow-xl">

      <template x-if="loaded">
        <div>

          <div class="mb-8">
            <p class="text-gray-400">Full Name</p>
            <input class="w-full p-3 mt-2 rounded bg-gray-700" x-model="realName">
          </div>

          <div class="mb-8">
            <p class="text-gray-400">Username</p>
            <input class="w-full p-3 mt-2 rounded bg-gray-700" x-model="username"/>
            <p class="mt-1 text-sm text-gray-500">Letters & numbers only</p>
          </div>

          <div class="mb-8">
            <p class="text-gray-400">New Password</p>
            <input type="password" class="w-full p-3 mt-2 rounded bg-gray-700" x-model="newPassword"/>
          </div>

          <button class="px-6 py-3 bg-green-600 rounded font-bold"
                  @click="saveChanges()">Save Changes</button>

          <div class="mt-10 border-t border-gray-700 pt-6">
            <button class="px-6 py-3 bg-red-700 rounded font-bold"
                    @click="deleteAccount()">Delete Account & All Sessions</button>
          </div>

          <div class="mt-6"
               x-text="msg"
               :class="err ? 'text-red-400' : 'text-green-400'"></div>

        </div>
      </template>

      <template x-if="!loaded">
        <p class="text-gray-400">Loading...</p>
      </template>

    </div>
  </div>

  <script>
    function accountPage() {
      return {
        loaded: false,
        realName: "",
        username: "",
        newPassword: "",
        msg: "",
        err: false,

        validateUsername(n) { return /^[A-Za-z0-9]+$/.test(n); },

        init() {
          window.auth.onAuthStateChanged(async user => {
            if (!user) { location.href = "/login.html"; return; }
            await this.loadAccount();
          });
        },

        async loadAccount() {
          const snap = await window.FS.getDoc(
            window.FS.doc(window.db, "users", window.currentUser.uid)
          );

          const data = snap.data();
          this.realName = data.realName;
          this.username = data.username;
          this.loaded = true;
        },

        async saveChanges() {
          this.msg = ""; this.err = false;

          if (!this.validateUsername(this.username)) {
            this.msg = "Invalid username."; this.err = true; return;
          }

          try {
            const userRef = window.FS.doc(window.db, "users", window.currentUser.uid);

            await window.FS.updateDoc(userRef, {
              realName: this.realName,
              username: this.username
            });

            // OPTION B1 — propagate username to all sessions
            const q = window.FS.query(
              window.FS.collection(window.db, "sessions"),
              window.FS.where("userId", "==", window.currentUser.uid)
            );

            const snap = await window.FS.getDocs(q);
            for (const d of snap.docs) {
              await window.FS.updateDoc(
                window.FS.doc(window.db, "sessions", d.id),
                { username: this.username }
              );
            }

            if (this.newPassword.length > 0) {
              await window.FS.updatePassword(window.currentUser, this.newPassword);
            }

            this.msg = "Account updated!";
          } catch (e) {
            this.msg = e.message; this.err = true;
          }
        },

        async deleteAccount() {
          if (!confirm("Delete your account and all sessions?")) return;

          try {
            // DELETE SESSIONS
            const q = window.FS.query(
              window.FS.collection(window.db, "sessions"),
              window.FS.where("userId", "==", window.currentUser.uid)
            );
            const snap = await window.FS.getDocs(q);
            for (const d of snap.docs) {
              await window.FS.deleteDoc(window.FS.doc(window.db, "sessions", d.id));
            }

            // DELETE USER DOCUMENT
            await window.FS.deleteDoc(
              window.FS.doc(window.db, "users", window.currentUser.uid)
            );

            // DELETE AUTH ACCOUNT
            await window.FS.deleteUser(window.currentUser);

            alert("Account deleted.");
            location.href = "/index.html";

          } catch (e) {
            this.msg = e.message; this.err = true;
          }
        }
      }
    }
  </script>

</body>
</html>