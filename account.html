<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account — Baltimore Poker Gang</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getAuth,
      onAuthStateChanged,
      updatePassword,
      deleteUser,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      deleteDoc,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKS9PstXhK_9lWVW6IRkCAJ_Gl0G8XlUw",
      authDomain: "baltimore-poker-gang.firebaseapp.com",
      projectId: "baltimore-poker-gang",
      storageBucket: "baltimore-poker-gang.appspot.com",
      messagingSenderId: "1082334625118",
      appId: "1:1082334625118:web:3f90a5721f9f1f2790a3cf"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.auth = auth;
    window.db = db;

    window.logout = async () => {
      await signOut(auth);
      window.location.href = "/index.html";
    };

    onAuthStateChanged(auth, user => {
      window.currentUser = user;
      window.dispatchEvent(new CustomEvent("auth-changed", { detail: user }));
    });

    window.FS = { doc, getDoc, updateDoc, deleteDoc, collection, getDocs, query, where, updatePassword, deleteUser };
  </script>
</head>

<body class="min-h-screen bg-gray-900"
      x-data="accountPage()"
      x-init="init()">

  <!-- NAVIGATION BAR -->
  <nav class="bg-black p-4 shadow-lg"
       x-data="{ user: null }"
       x-init="
         window.addEventListener('auth-changed', e => user = e.detail);
         user = window.currentUser;
       ">
    <div class="max-w-6xl mx-auto flex justify-between items-center">

      <a href="/index.html" class="text-2xl font-bold flex items-center gap-3">
        <i class="fas fa-diamond text-red-600"></i> Baltimore Poker Gang
      </a>

      <div class="flex gap-4">

        <!-- LOGGED OUT -->
        <template x-if="!user">
          <div class="flex gap-4">
            <a href="/leaderboard.html"
               class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold">
               Leaderboard
            </a>
            <a href="/login.html"
               class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded font-bold">
               Login / Sign Up
            </a>
          </div>
        </template>

        <!-- LOGGED IN -->
        <template x-if="user">
          <div class="flex gap-4">
            <a href="/leaderboard.html"
               class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold">
               Leaderboard
            </a>
            <a href="/sessions.html"
               class="px-6 py-2 bg-green-600 hover:bg-green-500 rounded font-bold">
               Sessions
            </a>
            <a href="/account.html"
               class="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold">
               My Account
            </a>
            <button @click="logout()"
               class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold">
               Logout
            </button>
          </div>
        </template>

      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="max-w-3xl mx-auto p-6">

    <h1 class="text-4xl font-bold text-center mb-10">My Account</h1>

    <!-- ACCOUNT INFO -->
    <div class="bg-gray-800 p-8 rounded-xl shadow-xl">

      <template x-if="loaded">
        <div>

          <div class="mb-8">
            <p class="text-gray-400">Full Name</p>
            <input class="w-full p-3 mt-2 rounded bg-gray-700"
                   x-model="realName">
          </div>

          <div class="mb-8">
            <p class="text-gray-400">Username</p>
            <input class="w-full p-3 mt-2 rounded bg-gray-700"
                   x-model="username">
            <p class="text-sm text-gray-500 mt-1">Letters and numbers only — no spaces.</p>
          </div>

          <div class="mb-8">
            <p class="text-gray-400">New Password</p>
            <input type="password"
                   class="w-full p-3 mt-2 rounded bg-gray-700"
                   x-model="newPassword">
          </div>

          <button @click="saveChanges()"
                  class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded font-bold">
            Save Changes
          </button>

          <!-- DELETE ACCOUNT -->
          <div class="mt-10 border-t border-gray-700 pt-6">
            <button @click="deleteAccount()"
                    class="px-6 py-3 bg-red-700 hover:bg-red-600 rounded font-bold">
              Delete Account & All Sessions
            </button>
          </div>

          <div class="mt-6" x-text="msg" :class="err ? 'text-red-400' : 'text-green-400'"></div>
        </div>
      </template>

      <template x-if="!loaded">
        <p>Loading...</p>
      </template>

    </div>
  </div>

  <script>
    function accountPage() {
      return {
        loaded: false,
        realName: "",
        username: "",
        newPassword: "",
        msg: "",
        err: false,
        docId: null,

        validateUsername(name) {
          return /^[a-zA-Z0-9]+$/.test(name);
        },

        async init() {
          if (!window.currentUser) {
            window.location.href = "/login.html";
            return;
          }

          const { doc, getDoc } = window.FS;

          const userDoc = await getDoc(doc(window.db, "users", window.currentUser.uid));

          if (!userDoc.exists()) {
            this.msg = "User record not found.";
            this.err = true;
            return;
          }

          const data = userDoc.data();

          this.realName = data.realName;
          this.username = data.username;
          this.docId = userDoc.id;

          this.loaded = true;
        },

        async saveChanges() {
          this.msg = "";
          this.err = false;

          if (!this.validateUsername(this.username)) {
            this.msg = "Username may only contain letters & numbers.";
            this.err = true;
            return;
          }

          const { doc, updateDoc, updatePassword } = window.FS;

          try {
            // Update Firestore profile
            await updateDoc(doc(window.db, "users", window.currentUser.uid), {
              realName: this.realName,
              username: this.username
            });

            // Update password if provided
            if (this.newPassword.length > 0) {
              await updatePassword(window.currentUser, this.newPassword);
            }

            this.msg = "Profile updated successfully!";
            this.err = false;

          } catch (e) {
            this.msg = e.message;
            this.err = true;
          }
        },

        async deleteAccount() {
          if (!confirm("Are you sure you want to delete your account AND all sessions?")) {
            return;
          }

          const { doc, deleteDoc, collection, getDocs, query, where, deleteUser } = window.FS;

          try {
            // Delete all sessions
            const q = query(
              collection(window.db, "sessions"),
              where("userId", "==", window.currentUser.uid)
            );

            const snap = await getDocs(q);
            for (const d of snap.docs) {
              await deleteDoc(doc(window.db, "sessions", d.id));
            }

            // Delete user Firestore record
            await deleteDoc(doc(window.db, "users", window.currentUser.uid));

            // Delete Auth user
            await deleteUser(window.currentUser);

            alert("Account deleted.");
            window.location.href = "/index.html";

          } catch (e) {
            this.msg = e.message;
            this.err = true;
          }
        }
      }
    }
  </script>

</body>
</html>